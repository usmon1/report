import time
from typing import Dict, Tuple
import hashlib

# In-memory Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð´Ð»Ñ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð²Ñ…Ð¾Ð´Ð°
# Ð’ Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ Ð»ÑƒÑ‡ÑˆÐµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Redis Ð¸Ð»Ð¸ Ð‘Ð”
failed_attempts: Dict[str, Tuple[int, float]] = {}

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸
MAX_ATTEMPTS = 5
LOCKOUT_TIME = 900  # 15 Ð¼Ð¸Ð½ÑƒÑ‚ Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
ATTEMPT_WINDOW = 3600  # 1 Ñ‡Ð°Ñ - Ð¾ÐºÐ½Ð¾ Ð´Ð»Ñ Ð¿Ð¾Ð´ÑÑ‡ÐµÑ‚Ð° Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº


def get_client_identifier(login: str, ip: str) -> str:
    """Ð¡Ð¾Ð·Ð´Ð°ÐµÑ‚ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð´Ð»Ñ ÐºÐ¾Ð¼Ð±Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð»Ð¾Ð³Ð¸Ð½+IP"""
    return hashlib.md5(f"{login}:{ip}".encode()).hexdigest()


def record_failed_attempt(login: str, ip: str):
    """Ð—Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½ÑƒÑŽ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÑƒ Ð²Ñ…Ð¾Ð´Ð°"""
    identifier = get_client_identifier(login, ip)
    now = time.time()

    if identifier in failed_attempts:
        count, first_attempt = failed_attempts[identifier]

        # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡Ð°ÑÐ° Ñ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸
        if now - first_attempt > ATTEMPT_WINDOW:
            failed_attempts[identifier] = (1, now)
        else:
            failed_attempts[identifier] = (count + 1, first_attempt)
    else:
        failed_attempts[identifier] = (1, now)

    print(f"ðŸ” ÐÐµÑƒÐ´Ð°Ñ‡Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´Ð°: {login} Ñ IP {ip}. ÐŸÐ¾Ð¿Ñ‹Ñ‚Ð¾Ðº: {failed_attempts[identifier][0]}")


def record_successful_attempt(login: str, ip: str):
    """Ð£Ð´Ð°Ð»ÑÐµÑ‚ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¾ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ°Ñ… Ð¿Ñ€Ð¸ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¼ Ð²Ñ…Ð¾Ð´Ðµ"""
    identifier = get_client_identifier(login, ip)
    if identifier in failed_attempts:
        del failed_attempts[identifier]
        print(f"ðŸ” Ð¡Ð±Ñ€Ð¾Ñ ÑÑ‡ÐµÑ‚Ñ‡Ð¸ÐºÐ° Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº Ð´Ð»Ñ: {login}")


def is_blocked(login: str, ip: str) -> Tuple[bool, int]:
    """
    ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÑ‚, Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½ Ð»Ð¸ Ð»Ð¾Ð³Ð¸Ð½/IP.
    Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ (Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½, Ð¾ÑÑ‚Ð°Ð²ÑˆÐµÐµÑÑ Ð²Ñ€ÐµÐ¼Ñ Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…)
    """
    identifier = get_client_identifier(login, ip)

    if identifier not in failed_attempts:
        return False, 0

    count, first_attempt = failed_attempts[identifier]
    now = time.time()

    # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡Ð°ÑÐ°
    if now - first_attempt > ATTEMPT_WINDOW:
        del failed_attempts[identifier]
        return False, 0

    if count >= MAX_ATTEMPTS:
        time_since_first = now - first_attempt
        if time_since_first < LOCKOUT_TIME:
            remaining = LOCKOUT_TIME - time_since_first
            return True, int(remaining)
        else:
            # Ð’Ñ€ÐµÐ¼Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¸ Ð¸ÑÑ‚ÐµÐºÐ»Ð¾, ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº
            del failed_attempts[identifier]
            return False, 0

    return False, 0


def get_remaining_attempts(login: str, ip: str) -> int:
    """Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¾ÑÑ‚Ð°Ð²ÑˆÐ¸Ñ…ÑÑ Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº"""
    identifier = get_client_identifier(login, ip)

    if identifier not in failed_attempts:
        return MAX_ATTEMPTS

    count, first_attempt = failed_attempts[identifier]

    # Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÑ‡ÐµÑ‚Ñ‡Ð¸Ðº ÐµÑÐ»Ð¸ Ð¿Ñ€Ð¾ÑˆÐ»Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ Ñ‡Ð°ÑÐ°
    if time.time() - first_attempt > ATTEMPT_WINDOW:
        del failed_attempts[identifier]
        return MAX_ATTEMPTS

    return MAX_ATTEMPTS - count