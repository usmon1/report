{% extends "admin/base.html" %}

{% block title %}–î–∞—à–±–æ—Ä–¥ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">üìä –î–∞—à–±–æ—Ä–¥ —Å–∏—Å—Ç–µ–º—ã</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="refreshDashboard()">
            üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        </button>
    </div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="stats-grid" id="stats-grid">
    <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...</div>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø -->
<div class="quick-actions">
    <h2>üöÄ –ë—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø</h2>
    <div class="actions-grid" id="quick-actions">
        <!-- –ë—ã—Å—Ç—Ä–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è JavaScript -->
    </div>
</div>

<style>
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-left: 4px solid var(--primary-color);
        transition: transform 0.3s;
    }

    .stat-card:hover {
        transform: translateY(-2px);
    }

    .stat-card.enterprises { border-left-color: #007bff; }
    .stat-card.services { border-left-color: #28a745; }
    .stat-card.periods { border-left-color: #ffc107; }
    .stat-card.users { border-left-color: #dc3545; }

    .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: var(--dark-color);
        margin-bottom: 5px;
    }

    .stat-label {
        font-size: 1em;
        color: #666;
        margin-bottom: 10px;
    }

    .stat-trend {
        font-size: 0.9em;
        padding: 3px 8px;
        border-radius: 12px;
        background: #f8f9fa;
        display: inline-block;
    }

    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }

    .quick-actions {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .quick-actions h2 {
        margin-bottom: 20px;
        color: var(--dark-color);
    }

    .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .action-card {
        background: var(--light-color);
        padding: 20px;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .action-card:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-2px);
        border-color: var(--primary-color);
    }

    .action-icon {
        font-size: 2em;
        margin-bottom: 10px;
    }

    .action-label {
        font-weight: 600;
    }
</style>

<script>
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞
    async function loadDashboardStats() {
        const statsGrid = document.getElementById('stats-grid');
        
        try {
            const response = await fetch('/api/admin/dashboard-stats');
            const data = await response.json();

            if (data.success) {
                renderStats(data.stats);
                renderQuickActions();
            } else {
                statsGrid.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${data.error}</div>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
            statsGrid.innerHTML = `<div class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ${error.message}</div>`;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function renderStats(stats) {
        const statsGrid = document.getElementById('stats-grid');
        
        statsGrid.innerHTML = `
            <div class="stat-card enterprises">
                <div class="stat-number">${stats.enterprises_count || 0}</div>
                <div class="stat-label">üè¢ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                <div class="stat-trend trend-up">+${stats.enterprises_trend || 0} –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
            
            <div class="stat-card services">
                <div class="stat-number">${stats.services_count || 0}</div>
                <div class="stat-label">‚öôÔ∏è –£—Å–ª—É–≥ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ</div>
                <div class="stat-trend trend-up">+${stats.services_trend || 0} –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
            
            <div class="stat-card periods">
                <div class="stat-number">${stats.periods_count || 0}</div>
                <div class="stat-label">üìÖ –û—Ç—á—ë—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤/–ø–µ—Ä–∏–æ–¥–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ (–≤—Å–µ–≥–æ)</div>
                <div class="stat-trend trend-up">+${stats.periods_trend || 0} –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
            
            <div class="stat-card users">
                <div class="stat-number">${stats.users_count || 0}</div>
                <div class="stat-label">üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å–∏—Å—Ç–µ–º—ã</div>
                <div class="stat-trend trend-up">+${stats.users_trend || 0} –∑–∞ –º–µ—Å—è—Ü</div>
            </div>
        `;
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    function renderQuickActions() {
        const quickActions = document.getElementById('quick-actions');
        
        quickActions.innerHTML = `
            <div class="action-card" onclick="navigateTo('/admin/enterprises?user_login={{ username }}&user_role={{ user_role }}')">
                <div class="action-icon">üè¢</div>
                <div class="action-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏</div>
            </div>
            
            <div class="action-card" onclick="navigateTo('/admin/services?user_login={{ username }}&user_role={{ user_role }}')">
                <div class="action-icon">‚öôÔ∏è</div>
                <div class="action-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</div>
            </div>
            
            <div class="action-card" onclick="navigateTo('/admin/periods?user_login={{ username }}&user_role={{ user_role }}')">
                <div class="action-icon">üìÖ</div>
                <div class="action-label">–û—Ç—á—ë—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã</div>
            </div>
            
            <div class="action-card" onclick="navigateTo('/admin/users?user_login={{ username }}&user_role={{ user_role }}')">
                <div class="action-icon">üë§</div>
                <div class="action-label">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</div>
            </div>
        `;
    }

    // –§—É–Ω–∫—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    function navigateTo(url) {
        window.location.href = url;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞—à–±–æ—Ä–¥–∞
    function refreshDashboard() {
        loadDashboardStats();
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.refreshPageData = function() {
        loadDashboardStats();
    };

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadDashboardStats();
    });
</script>
{% endblock %}