{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">üè¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ
        </button>
        <button class="btn btn-warning" onclick="openEditModal()" id="editBtn" disabled>
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn btn-danger" onclick="deleteEnterprise()" id="deleteBtn" disabled>
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
        </button>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã -->
<div class="filters-section">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è..." 
               onkeyup="filterEnterprises()" style="width: 300px; padding: 8px;">
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="table-container">
    <table id="enterprisesTable" class="data-table">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</th>
                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                <th>–ö–æ–¥ –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞</th>
                <th>–ö–æ–¥ –æ—Ç—Ä–∞—Å–ª–∏</th>
                <th>–ö–æ–¥ –æ–±–ª–∞—Å—Ç–∏</th>
            </tr>
        </thead>
        <tbody id="enterprisesTableBody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </tbody>
    </table>
    <div class="loading" id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="enterpriseModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3 id="modalTitle">üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-layout">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                <div class="form-section">
                    <h4>üìù –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞</h4>
                    <form id="enterpriseForm">
                        <div class="form-group">
                            <label for="enterpriseName">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è *</label>
                            <input type="text" id="enterpriseName" name="enterpriseName" required 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è">
                        </div>
                        
                        <div class="form-group">
                            <label for="regNumber">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä *</label>
                            <input type="number" id="regNumber" name="regNumber" required 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä">
                        </div>
                        
                        <div class="form-group">
                            <label for="ministryCode">–ö–æ–¥ –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞</label>
                            <div class="select-with-search">
                                <select id="ministryCode" name="ministryCode">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('ministries')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="industryCode">–ö–æ–¥ –æ—Ç—Ä–∞—Å–ª–∏</label>
                            <div class="select-with-search">
                                <select id="industryCode" name="industryCode">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ—Ç—Ä–∞—Å–ª—å --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('industries')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="regionCode">–ö–æ–¥ –æ–±–ª–∞—Å—Ç–∏</label>
                            <div class="select-with-search">
                                <select id="regionCode" name="regionCode">
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –æ–±–ª–∞—Å—Ç—å --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('regions')">üîç</button>
                            </div>
                        </div>
                    </form>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ -->
                <div class="reference-section">
                    <h4>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h4>
                    <div class="reference-tabs">
                        <button class="tab-btn active" onclick="showReference('ministries')">üèõÔ∏è –ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–∞</button>
                        <button class="tab-btn" onclick="showReference('industries')">üè≠ –û—Ç—Ä–∞—Å–ª–∏</button>
                        <button class="tab-btn" onclick="showReference('regions')">üåç –û–±–ª–∞—Å—Ç–∏</button>
                    </div>
                    
                    <div class="reference-search">
                        <input type="text" id="referenceSearch" placeholder="üîç –ü–æ–∏—Å–∫..." 
                               onkeyup="searchReference()">
                    </div>
                    
                    <div class="reference-table-container">
                        <table class="reference-table">
                            <thead>
                                <tr>
                                    <th width="60">ID</th>
                                    <th width="80">–ö–æ–¥</th>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody id="referenceTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" onclick="saveEnterprise()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        </div>
        <div class="modal-body">
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ?</p>
            <p id="confirmMessage" class="warning-text"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .data-table tbody tr.selected {
        background: #e3f2fd;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 2% auto;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .large-modal {
        width: 90%;
        max-width: 1200px;
        height: 80vh;
    }

    .confirm-modal {
        width: 500px;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
        height: calc(100% - 120px);
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        text-align: right;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }

    .close:hover {
        color: #333;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è layout –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        height: 100%;
    }

    .form-section, .reference-section {
        display: flex;
        flex-direction: column;
    }

    .form-section h4, .reference-section h4 {
        margin-bottom: 20px;
        color: #333;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º—ã */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #007bff;
    }

    .select-with-search {
        display: flex;
        gap: 5px;
    }

    .select-with-search select {
        flex: 1;
    }

    .search-btn {
        padding: 10px 15px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

    .search-btn:hover {
        background: #e9ecef;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ */
    .reference-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #ddd;
    }

    .tab-btn {
        padding: 10px 15px;
        background: none;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }

    .reference-search {
        margin-bottom: 15px;
    }

    .reference-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reference-table th,
    .reference-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
    }

    .reference-table th {
        background: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .reference-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #333;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    /* –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .search-box input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    /* –¢–µ–∫—Å—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */
    .warning-text {
        color: #dc3545;
        font-weight: 600;
        margin-top: 10px;
    }

    /* –ó–∞–≥—Ä—É–∑–∫–∞ */
    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let enterprises = [];
    let selectedEnterprise = null;
    let currentReference = 'ministries';
    let references = {
        ministries: [],
        industries: [],
        regions: []
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadEnterprises();
        loadReferences();
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
    async function loadEnterprises() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableBody = document.getElementById('enterprisesTableBody');
        
        try {
            loadingIndicator.style.display = 'block';
            tableBody.innerHTML = '';
            
            const response = await fetch('/api/admin/enterprises');
            const data = await response.json();
            
            if (data.success) {
                enterprises = data.enterprises;
                renderEnterprisesTable();
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</td></tr>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π:', error);
            tableBody.innerHTML = `<tr><td colspan="6" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
    function renderEnterprisesTable() {
        const tableBody = document.getElementById('enterprisesTableBody');
        
        if (enterprises.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px;">–ù–µ—Ç –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
            return;
        }
        
        tableBody.innerHTML = enterprises.map(enterprise => `
            <tr onclick="selectEnterprise(${enterprise.reg_number})" 
                class="${selectedEnterprise && selectedEnterprise.reg_number === enterprise.reg_number ? 'selected' : ''}">
                <td><input type="checkbox" onchange="toggleEnterpriseSelection(${enterprise.reg_number})" 
                    ${selectedEnterprise && selectedEnterprise.reg_number === enterprise.reg_number ? 'checked' : ''}></td>
                <td>${escapeHtml(enterprise.name)}</td>
                <td>${enterprise.reg_number}</td>
                <td>${enterprise.ministry_code || '‚Äî'}</td>
                <td>${enterprise.industry_code || '‚Äî'}</td>
                <td>${enterprise.region_code || '‚Äî'}</td>
            </tr>
        `).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
    function selectEnterprise(regNumber) {
        selectedEnterprise = enterprises.find(e => e.reg_number === regNumber);
        renderEnterprisesTable();
        updateActionButtons();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
    function updateActionButtons() {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (selectedEnterprise) {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
        } else {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
    function filterEnterprises() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (!searchTerm) {
            renderEnterprisesTable();
            return;
        }
        
        const filteredEnterprises = enterprises.filter(enterprise => 
            enterprise.name.toLowerCase().includes(searchTerm)
        );
        
        const tableBody = document.getElementById('enterprisesTableBody');
        tableBody.innerHTML = filteredEnterprises.map(enterprise => `
            <tr onclick="selectEnterprise(${enterprise.reg_number})" 
                class="${selectedEnterprise && selectedEnterprise.reg_number === enterprise.reg_number ? 'selected' : ''}">
                <td><input type="checkbox" onchange="toggleEnterpriseSelection(${enterprise.reg_number})" 
                    ${selectedEnterprise && selectedEnterprise.reg_number === enterprise.reg_number ? 'checked' : ''}></td>
                <td>${escapeHtml(enterprise.name)}</td>
                <td>${enterprise.reg_number}</td>
                <td>${enterprise.ministry_code || '‚Äî'}</td>
                <td>${enterprise.industry_code || '‚Äî'}</td>
                <td>${enterprise.region_code || '‚Äî'}</td>
            </tr>
        `).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
    async function loadReferences() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const [ministriesRes, industriesRes, regionsRes] = await Promise.all([
                fetch('/api/admin/reference/ministries'),
                fetch('/api/admin/reference/industries'),
                fetch('/api/admin/reference/regions')
            ]);
            
            const ministriesData = await ministriesRes.json();
            const industriesData = await industriesRes.json();
            const regionsData = await regionsRes.json();
            
            if (ministriesData.success) references.ministries = ministriesData.data;
            if (industriesData.success) references.industries = industriesData.data;
            if (regionsData.success) references.regions = regionsData.data;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
            fillSelectOptions('ministryCode', references.ministries);
            fillSelectOptions('industryCode', references.industries);
            fillSelectOptions('regionCode', references.regions);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            showReference('ministries');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    function fillSelectOptions(selectId, data) {
        const select = document.getElementById(selectId);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        const currentValue = select.value;
        
        // –û—á–∏—â–∞–µ–º –∏ –∑–∞–ø–æ–ª–Ω—è–µ–º –∑–∞–Ω–æ–≤–æ
        select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>';
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item.code;
            option.textContent = `${item.code} - ${item.name}`;
            select.appendChild(option);
        });
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
        if (currentValue) {
            select.value = currentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function showReference(type) {
        currentReference = type;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –≤–∫–ª–∞–¥–∫—É
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
        const tableBody = document.getElementById('referenceTableBody');
        const data = references[type];
        
        tableBody.innerHTML = data.map(item => `
            <tr onclick="selectReferenceItem('${type}', ${item.code}, '${escapeHtml(item.name)}')">
                <td>${item.id || '‚Äî'}</td>
                <td>${item.code}</td>
                <td>${escapeHtml(item.name)}</td>
            </tr>
        `).join('');
        
        // –û—á–∏—â–∞–µ–º –ø–æ–∏—Å–∫
        document.getElementById('referenceSearch').value = '';
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function selectReferenceItem(type, code, name) {
        const selectId = type === 'ministries' ? 'ministryCode' : 
                        type === 'industries' ? 'industryCode' : 'regionCode';
        
        document.getElementById(selectId).value = code;
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
        document.querySelectorAll('#referenceTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        event.target.closest('tr').classList.add('selected');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    function searchReference() {
        const searchTerm = document.getElementById('referenceSearch').value.toLowerCase();
        const data = references[currentReference];
        
        const filteredData = data.filter(item => 
            item.name.toLowerCase().includes(searchTerm) || 
            item.code.toString().includes(searchTerm)
        );
        
        const tableBody = document.getElementById('referenceTableBody');
        tableBody.innerHTML = filteredData.map(item => `
            <tr onclick="selectReferenceItem('${currentReference}', ${item.code}, '${escapeHtml(item.name)}')">
                <td>${item.id || '‚Äî'}</td>
                <td>${item.code}</td>
                <td>${escapeHtml(item.name)}</td>
            </tr>
        `).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('modalTitle').textContent = 'üìù –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è';
        document.getElementById('enterpriseForm').reset();
        selectedEnterprise = null;
        document.getElementById('enterpriseModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function openEditModal() {
        if (!selectedEnterprise) return;
        
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è';
        document.getElementById('enterpriseName').value = selectedEnterprise.name;
        document.getElementById('regNumber').value = selectedEnterprise.reg_number;
        document.getElementById('regNumber').readOnly = true; // –†–µ–≥. –Ω–æ–º–µ—Ä –Ω–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å
        document.getElementById('ministryCode').value = selectedEnterprise.ministry_code || '';
        document.getElementById('industryCode').value = selectedEnterprise.industry_code || '';
        document.getElementById('regionCode').value = selectedEnterprise.region_code || '';
        
        document.getElementById('enterpriseModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        document.getElementById('enterpriseModal').style.display = 'none';
        document.getElementById('regNumber').readOnly = false; // –°–Ω–∏–º–∞–µ–º –±–ª–æ–∫–∏—Ä–æ–≤–∫—É
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
    async function saveEnterprise() {
        const formData = {
            name: document.getElementById('enterpriseName').value,
            reg_number: parseInt(document.getElementById('regNumber').value),
            ministry_code: document.getElementById('ministryCode').value || null,
            industry_code: document.getElementById('industryCode').value || null,
            region_code: document.getElementById('regionCode').value || null
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.name || !formData.reg_number) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä)');
            return;
        }
        
        try {
            const url = selectedEnterprise ? 
                `/api/admin/enterprises/${selectedEnterprise.reg_number}` : 
                '/api/admin/enterprises';
                
            const method = selectedEnterprise ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadEnterprises(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                showNotification('–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è
    function deleteEnterprise() {
        if (!selectedEnterprise) return;
        
        document.getElementById('confirmMessage').textContent = 
            `–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ: "${selectedEnterprise.name}" (–†–µ–≥. –Ω–æ–º–µ—Ä: ${selectedEnterprise.reg_number})`;
        document.getElementById('confirmModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    async function confirmDelete() {
        if (!selectedEnterprise) return;
        
        try {
            const response = await fetch(`/api/admin/enterprises/${selectedEnterprise.reg_number}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeConfirmModal();
                selectedEnterprise = null;
                loadEnterprises(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
                showNotification('–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        alert(message);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    window.refreshPageData = function() {
        loadEnterprises();
    };
</script>
{% endblock %}