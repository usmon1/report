{% extends "admin/base.html" %}

{% block title %}–û—Ç—á—ë—Ç–Ω—ã–µ –ø–µ—Ä–∏–æ–¥—ã - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">üìÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω—ã–º–∏ –ø–µ—Ä–∏–æ–¥–∞–º–∏</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–∏–æ–¥
        </button>
        <button class="btn btn-warning" onclick="openEditModal()" id="editBtn" disabled>
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn btn-danger" onclick="deletePeriod()" id="deleteBtn" disabled>
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
        </button>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-section">
    <div class="filter-row">
        <div class="filter-group">
            <label for="enterpriseFilter">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ:</label>
            <select id="enterpriseFilter" onchange="filterPeriods()">
                <option value="">–í—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="yearFilter">–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</label>
            <select id="yearFilter" onchange="filterPeriods()">
                <option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>
            </select>
        </div>
        <div class="filter-group">
            <button class="btn btn-secondary" onclick="clearFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="table-container">
    <table id="periodsTable" class="data-table">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                <th>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                <th>–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥</th>
                <th>–§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</th>
            </tr>
        </thead>
        <tbody id="periodsTableBody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </tbody>
    </table>
    <div class="loading" id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—á—ë—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="periodModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3 id="modalTitle">‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-layout">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                <div class="form-section">
                    <h4>üìù –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞</h4>
                    <form id="periodForm">
                        <div class="form-group">
                            <label for="enterpriseSelect">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ *</label>
                            <div class="select-with-search">
                                <select id="enterpriseSelect" name="enterprise" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('enterprises')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reportYear">–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ *</label>
                            <input type="number" id="reportYear" name="reportYear" required 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2024)" min="2000" max="2100">
                        </div>
                        
                        <div class="form-group">
                            <label for="directorName">–§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞</label>
                            <input type="text" id="directorName" name="directorName" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –¥–∏—Ä–µ–∫—Ç–æ—Ä–∞">
                        </div>
                    </form>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ -->
                <div class="reference-section">
                    <h4>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h4>
                    <div class="reference-tabs">
                        <button class="tab-btn active" onclick="showReference('enterprises')">üè¢ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</button>
                    </div>
                    
                    <div class="reference-search">
                        <input type="text" id="referenceSearch" placeholder="üîç –ü–æ–∏—Å–∫..." 
                               onkeyup="searchReference()">
                    </div>
                    
                    <div class="reference-table-container">
                        <table class="reference-table">
                            <thead>
                                <tr>
                                    <th width="100">–†–µ–≥. –Ω–æ–º–µ—Ä</th>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody id="referenceTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" onclick="savePeriod()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        </div>
        <div class="modal-body">
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥?</p>
            <p id="confirmMessage" class="warning-text"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-row {
        display: flex;
        gap: 20px;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-width: 200px;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã enterprises.html */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .data-table tbody tr.selected {
        background: #e3f2fd;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 2% auto;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .large-modal {
        width: 90%;
        max-width: 1200px;
        height: 80vh;
    }

    .confirm-modal {
        width: 500px;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
        height: calc(100% - 120px);
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        text-align: right;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }

    .close:hover {
        color: #333;
    }

    /* Layout –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        height: 100%;
    }

    .form-section, .reference-section {
        display: flex;
        flex-direction: column;
    }

    .form-section h4, .reference-section h4 {
        margin-bottom: 20px;
        color: #333;
    }

    /* –§–æ—Ä–º–∞ */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #007bff;
    }

    .select-with-search {
        display: flex;
        gap: 5px;
    }

    .select-with-search select {
        flex: 1;
    }

    .search-btn {
        padding: 10px 15px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

    .search-btn:hover {
        background: #e9ecef;
    }

    /* –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ */
    .reference-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #ddd;
    }

    .tab-btn {
        padding: 10px 15px;
        background: none;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }

    .reference-search {
        margin-bottom: 15px;
    }

    .reference-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reference-table th,
    .reference-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
    }

    .reference-table th {
        background: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .reference-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #333;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .warning-text {
        color: #dc3545;
        font-weight: 600;
        margin-top: 10px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let periods = [];
    let selectedPeriod = null;
    let enterprises = [];
    let currentReference = 'enterprises';
    let references = {
        enterprises: []
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadPeriods();
        loadEnterprisesForFilter();
        loadReferences();
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á—ë—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤
    async function loadPeriods() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableBody = document.getElementById('periodsTableBody');
        
        try {
            loadingIndicator.style.display = 'block';
            tableBody.innerHTML = '';
            
            const response = await fetch('/api/admin/periods');
            const data = await response.json();
            
            if (data.success) {
                periods = data.periods;
                renderPeriodsTable();
                updateYearFilterOptions();
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</td></tr>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–∏–æ–¥–æ–≤:', error);
            tableBody.innerHTML = `<tr><td colspan="5" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–∞ –≥–æ–¥–æ–≤
    function updateYearFilterOptions() {
        const yearFilter = document.getElementById('yearFilter');
        const currentValue = yearFilter.value;
        
        yearFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>';
        
        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ–¥—ã –∏–∑ –ø–µ—Ä–∏–æ–¥–æ–≤
        const uniqueYears = [...new Set(periods.map(p => p.year))].sort((a, b) => b - a);
        
        uniqueYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        });
        
        if (currentValue) {
            yearFilter.value = currentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
    async function loadEnterprisesForFilter() {
        try {
            const response = await fetch('/api/admin/reference/enterprises');
            const data = await response.json();
            
            if (data.success) {
                enterprises = data.data;
                const enterpriseFilter = document.getElementById('enterpriseFilter');
                
                enterprises.forEach(enterprise => {
                    const option = document.createElement('option');
                    option.value = enterprise.reg_number;
                    option.textContent = `${enterprise.name} (${enterprise.reg_number})`;
                    enterpriseFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–µ—Ä–∏–æ–¥–æ–≤
    function renderPeriodsTable(filteredPeriods = null) {
        const tableBody = document.getElementById('periodsTableBody');
        const dataToRender = filteredPeriods || periods;
        
        if (dataToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">–ù–µ—Ç –æ—Ç—á—ë—Ç–Ω—ã—Ö –ø–µ—Ä–∏–æ–¥–æ–≤ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
            return;
        }
        
        tableBody.innerHTML = dataToRender.map(period => {
            const isSelected = selectedPeriod && 
                              parseInt(selectedPeriod.reg_number) === parseInt(period.reg_number) && 
                              parseInt(selectedPeriod.year) === parseInt(period.year);
            
            return `
                <tr onclick="selectPeriod('${period.reg_number}', ${period.year})" 
                    class="${isSelected ? 'selected' : ''}">
                    <td>
                        <input type="checkbox" 
                               onchange="togglePeriodSelection('${period.reg_number}', ${period.year})" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${escapeHtml(period.enterprise_name)}</td>
                    <td>${period.reg_number}</td>
                    <td>${period.year}</td>
                    <td>${escapeHtml(period.director_name || '‚Äî')}</td>
                </tr>
            `;
        }).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–µ—Ä–∏–æ–¥–∞
    function selectPeriod(regNumber, year) {
        const numRegNumber = parseInt(regNumber);
        const numYear = parseInt(year);
        
        selectedPeriod = periods.find(p => 
            parseInt(p.reg_number) === numRegNumber && parseInt(p.year) === numYear
        );
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        document.querySelectorAll('#periodsTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
        event.currentTarget.classList.add('selected');
        
        updateActionButtons();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞
    function togglePeriodSelection(regNumber, year) {
        const numRegNumber = parseInt(regNumber);
        const numYear = parseInt(year);
        
        if (selectedPeriod && selectedPeriod.reg_number === numRegNumber && selectedPeriod.year === numYear) {
            selectedPeriod = null;
        } else {
            selectedPeriod = periods.find(p => 
                parseInt(p.reg_number) === numRegNumber && parseInt(p.year) === numYear
            );
        }
        
        renderPeriodsTable();
        updateActionButtons();
        event.stopPropagation();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
    function updateActionButtons() {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (selectedPeriod) {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
        } else {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–µ—Ä–∏–æ–¥–æ–≤
    function filterPeriods() {
        const enterpriseFilter = document.getElementById('enterpriseFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        
        let filteredPeriods = periods;
        
        if (enterpriseFilter) {
            filteredPeriods = filteredPeriods.filter(period => 
                period.reg_number.toString() === enterpriseFilter
            );
        }
        
        if (yearFilter) {
            filteredPeriods = filteredPeriods.filter(period => 
                period.year.toString() === yearFilter
            );
        }
        
        renderPeriodsTable(filteredPeriods);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function clearFilters() {
        document.getElementById('enterpriseFilter').value = '';
        document.getElementById('yearFilter').value = '';
        renderPeriodsTable();
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
    async function loadReferences() {
        try {
            const response = await fetch('/api/admin/reference/enterprises');
            const data = await response.json();
            
            if (data.success) {
                references.enterprises = data.data;
                fillEnterpriseSelect();
                showReference('enterprises');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
    function fillEnterpriseSelect() {
        const select = document.getElementById('enterpriseSelect');
        const currentValue = select.value;
        
        select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ --</option>';
        references.enterprises.forEach(enterprise => {
            const option = document.createElement('option');
            option.value = enterprise.reg_number;
            option.textContent = `${enterprise.name} (${enterprise.reg_number})`;
            select.appendChild(option);
        });
        
        if (currentValue) {
            select.value = currentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function showReference(type) {
        currentReference = type;
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const tableBody = document.getElementById('referenceTableBody');
        const data = references[type];
        
        tableBody.innerHTML = data.map(item => `
            <tr onclick="selectReferenceItem('${type}', '${item.reg_number}', '${escapeHtml(item.name)}')">
                <td>${item.reg_number}</td>
                <td>${escapeHtml(item.name)}</td>
            </tr>
        `).join('');
        
        document.getElementById('referenceSearch').value = '';
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function selectReferenceItem(type, regNumber, name) {
        document.getElementById('enterpriseSelect').value = regNumber;
        
        document.querySelectorAll('#referenceTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        event.target.closest('tr').classList.add('selected');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    function searchReference() {
        const searchTerm = document.getElementById('referenceSearch').value.toLowerCase();
        const data = references[currentReference];
        
        const filteredData = data.filter(item => 
            item.name.toLowerCase().includes(searchTerm) || 
            item.reg_number.toString().includes(searchTerm)
        );
        
        const tableBody = document.getElementById('referenceTableBody');
        tableBody.innerHTML = filteredData.map(item => `
            <tr onclick="selectReferenceItem('${currentReference}', '${item.reg_number}', '${escapeHtml(item.name)}')">
                <td>${item.reg_number}</td>
                <td>${escapeHtml(item.name)}</td>
            </tr>
        `).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞';
        document.getElementById('periodForm').reset();
        selectedPeriod = null;
        document.getElementById('periodModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function openEditModal() {
        if (!selectedPeriod) return;
        
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞';
        document.getElementById('enterpriseSelect').value = selectedPeriod.reg_number;
        document.getElementById('enterpriseSelect').disabled = true;
        document.getElementById('reportYear').value = selectedPeriod.year;
        document.getElementById('reportYear').readOnly = true;
        document.getElementById('directorName').value = selectedPeriod.director_name || '';
        
        document.getElementById('periodModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        document.getElementById('periodModal').style.display = 'none';
        document.getElementById('enterpriseSelect').disabled = false;
        document.getElementById('reportYear').readOnly = false;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
    async function savePeriod() {
        const formData = {
            reg_number: document.getElementById('enterpriseSelect').value,
            year: parseInt(document.getElementById('reportYear').value),
            director_name: document.getElementById('directorName').value || null
        };
        
        if (!formData.reg_number || !formData.year) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ –∏ –û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥)');
            return;
        }
        
        try {
            const url = selectedPeriod ? 
                `/api/admin/periods/${selectedPeriod.reg_number}/${selectedPeriod.year}` : 
                '/api/admin/periods';
                
            const method = selectedPeriod ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadPeriods();
                showNotification('–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞
    function deletePeriod() {
        if (!selectedPeriod) return;
        
        document.getElementById('confirmMessage').textContent = 
            `–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ: "${selectedPeriod.enterprise_name}" (–ì–æ–¥: ${selectedPeriod.year})`;
        document.getElementById('confirmModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    async function confirmDelete() {
        if (!selectedPeriod) return;
        
        try {
            const response = await fetch(`/api/admin/periods/${selectedPeriod.reg_number}/${selectedPeriod.year}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeConfirmModal();
                selectedPeriod = null;
                loadPeriods();
                showNotification('–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç—á—ë—Ç–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        alert(message);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    window.refreshPageData = function() {
        loadPeriods();
    };
</script>
{% endblock %}