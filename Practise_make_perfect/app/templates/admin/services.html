{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É
        </button>
        <button class="btn btn-warning" onclick="openEditModal()" id="editBtn" disabled>
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn btn-danger" onclick="deleteService()" id="deleteBtn" disabled>
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
        </button>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="filters-section">
    <div class="filter-row">
        <div class="filter-group">
            <label for="enterpriseFilter">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ:</label>
            <select id="enterpriseFilter" onchange="filterServices()">
                <option value="">–í—Å–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="yearFilter">–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥:</label>
            <select id="yearFilter" onchange="filterServices()">
                <option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="districtFilter">–†–∞–π–æ–Ω:</label>
            <select id="districtFilter" onchange="filterServices()">
                <option value="">–í—Å–µ —Ä–∞–π–æ–Ω—ã</option>
            </select>
        </div>
        <div class="filter-group">
            <button class="btn btn-secondary" onclick="clearFilters()">üîÑ –°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="table-container">
    <table id="servicesTable" class="data-table">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ</th>
                <th>–í–∏–¥ —É—Å–ª—É–≥–∏</th>
                <th>–†–∞–π–æ–Ω</th>
                <th>–ü–µ—Ä–∏–æ–¥</th>
                <th>–ö–æ–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è</th>
                <th>–ü–ª–∞–Ω –≤—Å–µ–≥–æ</th>
                <th>–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
            </tr>
        </thead>
        <tbody id="servicesTableBody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </tbody>
    </table>
    <div class="loading" id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å–ª—É–≥...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div id="serviceModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h3 id="modalTitle">‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="modal-layout">
                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                <div class="form-section">
                    <h4>üìù –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞</h4>
                    <form id="serviceForm">
                        <div class="form-group">
                            <label for="enterpriseSelect">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ *</label>
                            <div class="select-with-search">
                                <select id="enterpriseSelect" name="enterprise" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('enterprises')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="districtSelect">–†–∞–π–æ–Ω *</label>
                            <div class="select-with-search">
                                <select id="districtSelect" name="district" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–π–æ–Ω --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('districts')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="yearSelect">–û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ *</label>
                            <input type="number" id="yearSelect" name="year" required 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 2024)" min="2000" max="2100">
                        </div>
                        
                        <div class="form-group">
                            <label for="serviceTypeSelect">–í–∏–¥ —É—Å–ª—É–≥–∏ *</label>
                            <div class="select-with-search">
                                <select id="serviceTypeSelect" name="serviceType" required>
                                    <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —É—Å–ª—É–≥–∏ --</option>
                                </select>
                                <button type="button" class="search-btn" onclick="showReference('service_types')">üîç</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="indicatorCode">–ö–æ–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è</label>
                            <input type="number" id="indicatorCode" name="indicatorCode" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –ø–æ–∫–∞–∑–∞—Ç–µ–ª—è">
                        </div>
                        
                        <div class="form-group">
                            <label for="planTotal">–ü–ª–∞–Ω –≤—Å–µ–≥–æ</label>
                            <input type="number" id="planTotal" name="planTotal" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–ª–∞–Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ" min="0" step="0.01">
                        </div>
                        
                        <div class="form-group">
                            <label for="factTotal">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</label>
                            <input type="number" id="factTotal" name="factTotal" 
                                   placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ" min="0" step="0.01">
                        </div>
                    </form>
                </div>
                
                <!-- –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å - –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ -->
                <div class="reference-section">
                    <h4>üìö –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏</h4>
                    <div class="reference-tabs">
                        <button class="tab-btn active" onclick="showReference('enterprises')">üè¢ –ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</button>
                        <button class="tab-btn" onclick="showReference('districts')">üìç –†–∞–π–æ–Ω—ã</button>
                        <button class="tab-btn" onclick="showReference('service_types')">üìã –í–∏–¥—ã —É—Å–ª—É–≥</button>
                    </div>
                    
                    <div class="reference-search">
                        <input type="text" id="referenceSearch" placeholder="üîç –ü–æ–∏—Å–∫..." 
                               onkeyup="searchReference()">
                    </div>
                    
                    <div class="reference-table-container">
                        <table class="reference-table">
                            <thead>
                                <tr>
                                    <th width="100">–ö–æ–¥</th>
                                    <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                                </tr>
                            </thead>
                            <tbody id="referenceTableBody">
                                <!-- –î–∞–Ω–Ω—ã–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤ -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" onclick="saveService()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        </div>
        <div class="modal-body">
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—É—é —É—Å–ª—É–≥—É?</p>
            <p id="confirmMessage" class="warning-text"></p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .filter-row {
        display: flex;
        gap: 20px;
        align-items: end;
        flex-wrap: wrap;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .filter-group select {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        min-width: 200px;
    }

    /* –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –∞–Ω–∞–ª–æ–≥–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–∏–º —Ä–∞–∑–¥–µ–ª–∞–º */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .data-table tbody tr.selected {
        background: #e3f2fd;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 2% auto;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .large-modal {
        width: 90%;
        max-width: 1200px;
        height: 85vh;
    }

    .confirm-modal {
        width: 500px;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
        height: calc(100% - 120px);
        overflow-y: auto;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        text-align: right;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }

    .close:hover {
        color: #333;
    }

    /* Layout –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
    .modal-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        height: 100%;
    }

    .form-section, .reference-section {
        display: flex;
        flex-direction: column;
    }

    .form-section h4, .reference-section h4 {
        margin-bottom: 20px;
        color: #333;
    }

    /* –§–æ—Ä–º–∞ */
    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group input, .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #007bff;
    }

    .select-with-search {
        display: flex;
        gap: 5px;
    }

    .select-with-search select {
        flex: 1;
    }

    .search-btn {
        padding: 10px 15px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
    }

    .search-btn:hover {
        background: #e9ecef;
    }

    /* –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ */
    .reference-tabs {
        display: flex;
        margin-bottom: 15px;
        border-bottom: 1px solid #ddd;
    }

    .tab-btn {
        padding: 10px 15px;
        background: none;
        border: none;
        cursor: pointer;
        border-bottom: 2px solid transparent;
    }

    .tab-btn.active {
        border-bottom-color: #007bff;
        color: #007bff;
    }

    .reference-search {
        margin-bottom: 15px;
    }

    .reference-search input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table-container {
        flex: 1;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 5px;
    }

    .reference-table {
        width: 100%;
        border-collapse: collapse;
    }

    .reference-table th,
    .reference-table td {
        padding: 8px 12px;
        border-bottom: 1px solid #e0e0e0;
        text-align: left;
    }

    .reference-table th {
        background: #f8f9fa;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .reference-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #333;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .warning-text {
        color: #dc3545;
        font-weight: 600;
        margin-top: 10px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let services = [];
    let selectedService = null;
    let currentReference = 'enterprises';
    let references = {
        enterprises: [],
        districts: [],
        service_types: []
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadServices();
        loadFilters();
        loadReferences();
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥
    async function loadServices() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableBody = document.getElementById('servicesTableBody');
        
        try {
            loadingIndicator.style.display = 'block';
            tableBody.innerHTML = '';
            
            const response = await fetch('/api/admin/services');
            const data = await response.json();
            
            if (data.success) {
                services = data.services;
                renderServicesTable();
                updateFilters();
            } else {
                tableBody.innerHTML = `<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</td></tr>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—Å–ª—É–≥:', error);
            tableBody.innerHTML = `<tr><td colspan="8" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    async function loadFilters() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            const [enterprisesRes, districtsRes] = await Promise.all([
                fetch('/api/admin/reference/enterprises'),
                fetch('/api/admin/reference/districts')
            ]);
            
            const enterprisesData = await enterprisesRes.json();
            const districtsData = await districtsRes.json();
            
            if (enterprisesData.success) {
                const enterpriseFilter = document.getElementById('enterpriseFilter');
                enterprisesData.data.forEach(enterprise => {
                    const option = document.createElement('option');
                    option.value = enterprise.reg_number;
                    option.textContent = `${enterprise.name} (${enterprise.reg_number})`;
                    enterpriseFilter.appendChild(option);
                });
            }
            
            if (districtsData.success) {
                const districtFilter = document.getElementById('districtFilter');
                districtsData.data.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.code;
                    option.textContent = `${district.name} (${district.region_name})`;
                    districtFilter.appendChild(option);
                });
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function updateFilters() {
        updateYearFilterOptions();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø—Ü–∏–π —Ñ–∏–ª—å—Ç—Ä–∞ –≥–æ–¥–æ–≤
    function updateYearFilterOptions() {
        const yearFilter = document.getElementById('yearFilter');
        const currentValue = yearFilter.value;
        
        yearFilter.innerHTML = '<option value="">–í—Å–µ –ø–µ—Ä–∏–æ–¥—ã</option>';
        
        // –ü–æ–ª—É—á–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –≥–æ–¥—ã –∏–∑ —É—Å–ª—É–≥
        const uniqueYears = [...new Set(services.map(s => s.year))].sort((a, b) => b - a);
        
        uniqueYears.forEach(year => {
            const option = document.createElement('option');
            option.value = year;
            option.textContent = year;
            yearFilter.appendChild(option);
        });
        
        if (currentValue) {
            yearFilter.value = currentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã —É—Å–ª—É–≥
    function renderServicesTable(filteredServices = null) {
        const tableBody = document.getElementById('servicesTableBody');
        const dataToRender = filteredServices || services;
        
        if (dataToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">–ù–µ—Ç —É—Å–ª—É–≥ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
            return;
        }
        
        tableBody.innerHTML = dataToRender.map(service => {
            const isSelected = selectedService && selectedService.id === service.id;
            
            return `
                <tr onclick="selectService(${service.id})" 
                    class="${isSelected ? 'selected' : ''}">
                    <td>
                        <input type="checkbox" 
                               onchange="toggleServiceSelection(${service.id})" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${escapeHtml(service.enterprise_name)}</td>
                    <td>${escapeHtml(service.service_type)}</td>
                    <td>${escapeHtml(service.district_name)}</td>
                    <td>${service.year}</td>
                    <td>${service.indicator_code || '‚Äî'}</td>
                    <td>${service.plan_total || '‚Äî'}</td>
                    <td>${service.fact_total || '‚Äî'}</td>
                </tr>
            `;
        }).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏
    function selectService(serviceId) {
        selectedService = services.find(s => s.id === serviceId);
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        document.querySelectorAll('#servicesTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
        event.currentTarget.classList.add('selected');
        
        updateActionButtons();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞
    function toggleServiceSelection(serviceId) {
        if (selectedService && selectedService.id === serviceId) {
            selectedService = null;
        } else {
            selectedService = services.find(s => s.id === serviceId);
        }
        
        renderServicesTable();
        updateActionButtons();
        event.stopPropagation();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
    function updateActionButtons() {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        
        if (selectedService) {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
        } else {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥
    function filterServices() {
        const enterpriseFilter = document.getElementById('enterpriseFilter').value;
        const yearFilter = document.getElementById('yearFilter').value;
        const districtFilter = document.getElementById('districtFilter').value;
        
        let filteredServices = services;
        
        if (enterpriseFilter) {
            filteredServices = filteredServices.filter(service => 
                service.reg_number.toString() === enterpriseFilter
            );
        }
        
        if (yearFilter) {
            filteredServices = filteredServices.filter(service => 
                service.year.toString() === yearFilter
            );
        }
        
        if (districtFilter) {
            filteredServices = filteredServices.filter(service => 
                service.district_code.toString() === districtFilter
            );
        }
        
        renderServicesTable(filteredServices);
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–±—Ä–æ—Å–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function clearFilters() {
        document.getElementById('enterpriseFilter').value = '';
        document.getElementById('yearFilter').value = '';
        document.getElementById('districtFilter').value = '';
        renderServicesTable();
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
    async function loadReferences() {
        try {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
            const [enterprisesRes, districtsRes, serviceTypesRes] = await Promise.all([
                fetch('/api/admin/reference/enterprises'),
                fetch('/api/admin/reference/districts'),
                fetch('/api/admin/reference/service-types')
            ]);
            
            const enterprisesData = await enterprisesRes.json();
            const districtsData = await districtsRes.json();
            const serviceTypesData = await serviceTypesRes.json();
            
            if (enterprisesData.success) references.enterprises = enterprisesData.data;
            if (districtsData.success) references.districts = districtsData.data;
            if (serviceTypesData.success) references.service_types = serviceTypesData.data;
            
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
            fillSelectOptions('enterpriseSelect', references.enterprises, 'reg_number', 'name');
            fillSelectOptions('districtSelect', references.districts, 'code', 'name');
            fillSelectOptions('serviceTypeSelect', references.service_types, 'name', 'name');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            showReference('enterprises');
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤:', error);
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤
    function fillSelectOptions(selectId, data, valueField, textField) {
        const select = document.getElementById(selectId);
        const currentValue = select.value;
        
        select.innerHTML = `<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>`;
        data.forEach(item => {
            const option = document.createElement('option');
            option.value = item[valueField];
            option.textContent = item[textField];
            select.appendChild(option);
        });
        
        if (currentValue) {
            select.value = currentValue;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function showReference(type) {
        currentReference = type;
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        const tableBody = document.getElementById('referenceTableBody');
        const data = references[type];
        
        let tableHTML = '';
        
        if (type === 'enterprises') {
            tableHTML = data.map(item => `
                <tr onclick="selectReferenceItem('${type}', '${item.reg_number}', '${escapeHtml(item.name)}')">
                    <td>${item.reg_number}</td>
                    <td>${escapeHtml(item.name)}</td>
                </tr>
            `).join('');
        } else if (type === 'districts') {
            tableHTML = data.map(item => `
                <tr onclick="selectReferenceItem('${type}', '${item.code}', '${escapeHtml(item.name)}')">
                    <td>${item.code}</td>
                    <td>${escapeHtml(item.name)} (${item.region_name})</td>
                </tr>
            `).join('');
        } else if (type === 'service_types') {
            tableHTML = data.map(item => `
                <tr onclick="selectReferenceItem('${type}', '${escapeHtml(item.name)}', '${escapeHtml(item.name)}')">
                    <td>‚Äî</td>
                    <td>${escapeHtml(item.name)}</td>
                </tr>
            `).join('');
        }
        
        tableBody.innerHTML = tableHTML;
        document.getElementById('referenceSearch').value = '';
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞
    function selectReferenceItem(type, value, name) {
        let selectId;
        
        switch (type) {
            case 'enterprises':
                selectId = 'enterpriseSelect';
                break;
            case 'districts':
                selectId = 'districtSelect';
                break;
            case 'service_types':
                selectId = 'serviceTypeSelect';
                break;
        }
        
        if (selectId) {
            document.getElementById(selectId).value = value;
        }
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É
        document.querySelectorAll('#referenceTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        event.target.closest('tr').classList.add('selected');
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ –≤ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–µ
    function searchReference() {
        const searchTerm = document.getElementById('referenceSearch').value.toLowerCase();
        const data = references[currentReference];
        
        let filteredData;
        
        if (currentReference === 'enterprises') {
            filteredData = data.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.reg_number.toString().includes(searchTerm)
            );
        } else if (currentReference === 'districts') {
            filteredData = data.filter(item => 
                item.name.toLowerCase().includes(searchTerm) || 
                item.region_name.toLowerCase().includes(searchTerm) ||
                item.code.toString().includes(searchTerm)
            );
        } else if (currentReference === 'service_types') {
            filteredData = data.filter(item => 
                item.name.toLowerCase().includes(searchTerm)
            );
        }
        
        const tableBody = document.getElementById('referenceTableBody');
        
        let tableHTML = '';
        
        if (currentReference === 'enterprises') {
            tableHTML = filteredData.map(item => `
                <tr onclick="selectReferenceItem('${currentReference}', '${item.reg_number}', '${escapeHtml(item.name)}')">
                    <td>${item.reg_number}</td>
                    <td>${escapeHtml(item.name)}</td>
                </tr>
            `).join('');
        } else if (currentReference === 'districts') {
            tableHTML = filteredData.map(item => `
                <tr onclick="selectReferenceItem('${currentReference}', '${item.code}', '${escapeHtml(item.name)}')">
                    <td>${item.code}</td>
                    <td>${escapeHtml(item.name)} (${item.region_name})</td>
                </tr>
            `).join('');
        } else if (currentReference === 'service_types') {
            tableHTML = filteredData.map(item => `
                <tr onclick="selectReferenceItem('${currentReference}', '${escapeHtml(item.name)}', '${escapeHtml(item.name)}')">
                    <td>‚Äî</td>
                    <td>${escapeHtml(item.name)}</td>
                </tr>
            `).join('');
        }
        
        tableBody.innerHTML = tableHTML;
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∏';
        document.getElementById('serviceForm').reset();
        selectedService = null;
        document.getElementById('serviceModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function openEditModal() {
        if (!selectedService) return;
        
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏';
        document.getElementById('enterpriseSelect').value = selectedService.reg_number;
        document.getElementById('enterpriseSelect').disabled = true;
        document.getElementById('districtSelect').value = selectedService.district_code;
        document.getElementById('districtSelect').disabled = true;
        document.getElementById('yearSelect').value = selectedService.year;
        document.getElementById('yearSelect').readOnly = true;
        document.getElementById('serviceTypeSelect').value = selectedService.service_type;
        document.getElementById('serviceTypeSelect').disabled = true;
        document.getElementById('indicatorCode').value = selectedService.indicator_code || '';
        document.getElementById('planTotal').value = selectedService.plan_total || '';
        document.getElementById('factTotal').value = selectedService.fact_total || '';
        
        document.getElementById('serviceModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        document.getElementById('serviceModal').style.display = 'none';
        document.getElementById('enterpriseSelect').disabled = false;
        document.getElementById('districtSelect').disabled = false;
        document.getElementById('yearSelect').readOnly = false;
        document.getElementById('serviceTypeSelect').disabled = false;
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å–ª—É–≥–∏
    async function saveService() {
        const formData = {
            reg_number: document.getElementById('enterpriseSelect').value,
            district_code: parseInt(document.getElementById('districtSelect').value),
            year: parseInt(document.getElementById('yearSelect').value),
            service_type: document.getElementById('serviceTypeSelect').value,
            indicator_code: document.getElementById('indicatorCode').value || null,
            plan_total: document.getElementById('planTotal').value ? parseFloat(document.getElementById('planTotal').value) : null,
            fact_total: document.getElementById('factTotal').value ? parseFloat(document.getElementById('factTotal').value) : null
        };
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.reg_number || !formData.district_code || !formData.year || !formData.service_type) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è (–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ, –†–∞–π–æ–Ω, –û—Ç—á—ë—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥, –í–∏–¥ —É—Å–ª—É–≥–∏)');
            return;
        }
        
        try {
            const url = selectedService ? 
                `/api/admin/services/${selectedService.id}` : 
                '/api/admin/services';
                
            const method = selectedService ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadServices();
                showNotification('–£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å–ª—É–≥–∏:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —É—Å–ª—É–≥–∏');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏
    function deleteService() {
        if (!selectedService) return;
        
        document.getElementById('confirmMessage').textContent = 
            `–£—Å–ª—É–≥–∞: "${selectedService.service_type}" (–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ: ${selectedService.enterprise_name}, –ì–æ–¥: ${selectedService.year})`;
        document.getElementById('confirmModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    async function confirmDelete() {
        if (!selectedService) return;
        
        try {
            const response = await fetch(`/api/admin/services/${selectedService.id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeConfirmModal();
                selectedService = null;
                loadServices();
                showNotification('–£—Å–ª—É–≥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—Å–ª—É–≥–∏');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        alert(message);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    window.refreshPageData = function() {
        loadServices();
    };
</script>
{% endblock %}