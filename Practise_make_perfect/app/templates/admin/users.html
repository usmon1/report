{% extends "admin/base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% endblock %}

{% block content %}
<div class="content-header">
    <h1 class="page-title">üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddModal()">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        </button>
        <button class="btn btn-warning" onclick="openEditModal()" id="editBtn" disabled>
            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
        <button class="btn btn-danger" onclick="deleteUser()" id="deleteBtn" disabled>
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
        </button>
        <button class="btn btn-secondary" onclick="toggleUserStatus()" id="statusBtn" disabled>
            üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </div>
</div>

<!-- –ü–æ–∏—Å–∫ -->
<div class="filters-section">
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –§–ò–û, email –∏–ª–∏ –ª–æ–≥–∏–Ω—É..." 
               onkeyup="filterUsers()" style="width: 400px; padding: 8px;">
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
<div class="table-container">
    <table id="usersTable" class="data-table">
        <thead>
            <tr>
                <th width="40"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>ID</th>
                <th>–§–ò–û</th>
                <th>Email</th>
                <th>–õ–æ–≥–∏–Ω</th>
                <th>–†–æ–ª—å</th>
                <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
                <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
            </tr>
        </thead>
        <tbody id="usersTableBody">
            <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
        </tbody>
    </table>
    <div class="loading" id="loadingIndicator">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div id="userModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="userForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="fullName">–§–ò–û –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è *</label>
                        <input type="text" id="fullName" name="fullName" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞ *</label>
                        <input type="email" id="email" name="email" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ email –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="login">–õ–æ–≥–∏–Ω *</label>
                        <input type="text" id="login" name="login" required 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">–ü–∞—Ä–æ–ª—å <span id="passwordRequired">*</span></label>
                        <input type="password" id="password" name="password" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" 
                               oninput="validatePassword()">
                        <small class="help-text" id="passwordHelp">–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="role">–†–æ–ª—å *</label>
                        <select id="role" name="role" required onchange="checkAdminCount()">
                            <option value="user">user</option>
                            <option value="admin">admin</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">–°—Ç–∞—Ç—É—Å *</label>
                        <select id="status" name="status" required>
                            <option value="active">–ê–∫—Ç–∏–≤–µ–Ω</option>
                            <option value="blocked">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</option>
                        </select>
                    </div>
                </div>
                
                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è) -->
                <div id="userStats" class="user-stats" style="display: none;">
                    <h4>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                            <input type="text" id="regDate" readonly 
                                   style="background: #f8f9fa;">
                        </div>
                        
                        <div class="form-group">
                            <label>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</label>
                            <input type="text" id="lastLogin" readonly 
                                   style="background: #f8f9fa;">
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-primary" onclick="saveUser()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="confirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3>‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è</h3>
        </div>
        <div class="modal-body">
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?</p>
            <p id="confirmMessage" class="warning-text"></p>
            <div id="lastAdminWarning" class="alert alert-warning" style="display: none;">
                ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —Å–∏—Å—Ç–µ–º–µ. 
                –ü–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø—Ä–∞–≤–∞–º–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeConfirmModal()">‚ùå –ù–µ—Ç, –æ—Ç–º–µ–Ω–∏—Ç—å</button>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">‚úÖ –î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ -->
<div id="statusConfirmModal" class="modal">
    <div class="modal-content confirm-modal">
        <div class="modal-header">
            <h3 id="statusConfirmTitle">‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏</h3>
        </div>
        <div class="modal-body">
            <p id="statusConfirmMessage"></p>
            <div id="lastAdminStatusWarning" class="alert alert-warning" style="display: none;">
                ‚ö†Ô∏è <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –≤ —Å–∏—Å—Ç–µ–º–µ.
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeStatusConfirmModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
            <button type="button" class="btn btn-warning" id="statusConfirmBtn">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
        </div>
    </div>
</div>

<style>
    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .table-container {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow: hidden;
        margin-top: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .data-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #333;
    }

    .data-table tbody tr:hover {
        background: #f8f9fa;
        cursor: pointer;
    }

    .data-table tbody tr.selected {
        background: #e3f2fd;
    }

    /* –°—Ç–∞—Ç—É—Å—ã */
    .status-active {
        color: #28a745;
        font-weight: 600;
    }

    .status-blocked {
        color: #dc3545;
        font-weight: 600;
    }

    .role-admin {
        background: #007bff;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .role-user {
        background: #6c757d;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    /* –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 5% auto;
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        width: 600px;
        max-width: 90%;
    }

    .confirm-modal {
        width: 500px;
    }

    .modal-header {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .modal-body {
        padding: 20px;
    }

    .modal-footer {
        padding: 15px 20px;
        border-top: 1px solid #e0e0e0;
        text-align: right;
    }

    .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #999;
    }

    .close:hover {
        color: #333;
    }

    /* –§–æ—Ä–º–∞ */
    .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
    }

    .form-group {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
    }

    .form-group input, .form-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .form-group input:focus, .form-group select:focus {
        outline: none;
        border-color: #007bff;
    }

    .help-text {
        color: #6c757d;
        font-size: 12px;
        margin-top: 5px;
    }

    /* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
    .user-stats {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-top: 20px;
    }

    .user-stats h4 {
        margin-bottom: 15px;
        color: #333;
    }

    /* –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è */
    .alert {
        padding: 10px 15px;
        border-radius: 5px;
        margin: 10px 0;
    }

    .alert-warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .warning-text {
        color: #dc3545;
        font-weight: 600;
        margin-top: 10px;
    }

    /* –ö–Ω–æ–ø–∫–∏ */
    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        margin-left: 10px;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #333;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    /* –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ */
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }

    .search-box input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #666;
    }
</style>

<script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    let users = [];
    let selectedUser = null;
    let adminCount = 0;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', function() {
        loadUsers();
    });

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    async function loadUsers() {
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tableBody = document.getElementById('usersTableBody');
        
        try {
            loadingIndicator.style.display = 'block';
            tableBody.innerHTML = '';
            
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            
            if (data.success) {
                users = data.users;
                adminCount = data.admin_count;
                renderUsersTable();
            } else {
                tableBody.innerHTML = `<tr><td colspan="9" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${data.error}</td></tr>`;
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            tableBody.innerHTML = `<tr><td colspan="9" class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
        } finally {
            loadingIndicator.style.display = 'none';
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function renderUsersTable(filteredUsers = null) {
        const tableBody = document.getElementById('usersTableBody');
        const dataToRender = filteredUsers || users;
        
        if (dataToRender.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</td></tr>';
            return;
        }
        
        tableBody.innerHTML = dataToRender.map(user => {
            const isSelected = selectedUser && selectedUser.id === user.id;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç
            const regDate = user.reg_date ? new Date(user.reg_date).toLocaleDateString('ru-RU') : '‚Äî';
            const lastLogin = user.last_login ? new Date(user.last_login).toLocaleString('ru-RU') : '‚Äî';
            
            return `
                <tr onclick="selectUser(${user.id})" 
                    class="${isSelected ? 'selected' : ''}">
                    <td>
                        <input type="checkbox" 
                               onchange="toggleUserSelection(${user.id})" 
                               ${isSelected ? 'checked' : ''}>
                    </td>
                    <td>${user.id}</td>
                    <td>${escapeHtml(user.full_name)}</td>
                    <td>${escapeHtml(user.email)}</td>
                    <td>${escapeHtml(user.login)}</td>
                    <td><span class="role-${user.role}">${user.role}</span></td>
                    <td>${regDate}</td>
                    <td>${lastLogin}</td>
                    <td class="status-${user.status}">${user.status === 'active' ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}</td>
                </tr>
            `;
        }).join('');
    }

    // –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function selectUser(userId) {
        selectedUser = users.find(u => u.id === userId);
        
        // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫
        document.querySelectorAll('#usersTableBody tr').forEach(tr => {
            tr.classList.remove('selected');
        });
        
        // –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é —Å—Ç—Ä–æ–∫—É
        event.currentTarget.classList.add('selected');
        
        updateActionButtons();
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á–µ–∫–±–æ–∫—Å–∞
    function toggleUserSelection(userId) {
        if (selectedUser && selectedUser.id === userId) {
            selectedUser = null;
        } else {
            selectedUser = users.find(u => u.id === userId);
        }
        
        renderUsersTable();
        updateActionButtons();
        event.stopPropagation();
    }

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
    function updateActionButtons() {
        const editBtn = document.getElementById('editBtn');
        const deleteBtn = document.getElementById('deleteBtn');
        const statusBtn = document.getElementById('statusBtn');
        
        if (selectedUser) {
            editBtn.disabled = false;
            deleteBtn.disabled = false;
            statusBtn.disabled = false;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
            statusBtn.textContent = selectedUser.status === 'active' ? 'üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å';
            statusBtn.className = selectedUser.status === 'active' ? 'btn btn-warning' : 'btn btn-success';
        } else {
            editBtn.disabled = true;
            deleteBtn.disabled = true;
            statusBtn.disabled = true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    function filterUsers() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        
        if (!searchTerm) {
            renderUsersTable();
            return;
        }
        
        const filteredUsers = users.filter(user => 
            user.full_name.toLowerCase().includes(searchTerm) ||
            user.email.toLowerCase().includes(searchTerm) ||
            user.login.toLowerCase().includes(searchTerm)
        );
        
        renderUsersTable(filteredUsers);
    }

    // –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    function checkAdminCount() {
        // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–æ–ª–∏
        // –ü–æ–∫–∞ –æ—Å—Ç–∞–≤–∏–º –ø—É—Å—Ç–æ–π, –ª–æ–≥–∏–∫—É —Ä–µ–∞–ª–∏–∑—É–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    }

    // –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—è
    function validatePassword() {
        const password = document.getElementById('password').value;
        const passwordHelp = document.getElementById('passwordHelp');
        const isEditMode = selectedUser !== null;
        
        if (!isEditMode && password.length > 0 && password.length < 6) {
            passwordHelp.style.color = '#dc3545';
            passwordHelp.textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
            return false;
        } else {
            passwordHelp.style.color = '#6c757d';
            passwordHelp.textContent = '–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
            return true;
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function openAddModal() {
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        document.getElementById('userForm').reset();
        document.getElementById('passwordRequired').style.display = 'inline';
        document.getElementById('userStats').style.display = 'none';
        document.getElementById('password').required = true;
        selectedUser = null;
        
        document.getElementById('userModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    function openEditModal() {
        if (!selectedUser) return;
        
        document.getElementById('modalTitle').textContent = '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
        document.getElementById('fullName').value = selectedUser.full_name;
        document.getElementById('email').value = selectedUser.email;
        document.getElementById('login').value = selectedUser.login;
        document.getElementById('role').value = selectedUser.role;
        document.getElementById('status').value = selectedUser.status;
        document.getElementById('password').value = '';
        document.getElementById('passwordRequired').style.display = 'none';
        document.getElementById('password').required = false;
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        document.getElementById('regDate').value = selectedUser.reg_date ? 
            new Date(selectedUser.reg_date).toLocaleString('ru-RU') : '‚Äî';
        document.getElementById('lastLogin').value = selectedUser.last_login ? 
            new Date(selectedUser.last_login).toLocaleString('ru-RU') : '‚Äî';
        document.getElementById('userStats').style.display = 'block';
        
        document.getElementById('userModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    function closeModal() {
        document.getElementById('userModal').style.display = 'none';
    }

    // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function saveUser() {
        const formData = {
            full_name: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            login: document.getElementById('login').value,
            role: document.getElementById('role').value,
            status: document.getElementById('status').value
        };
        
        // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω —É–∫–∞–∑–∞–Ω –∏–ª–∏ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        const password = document.getElementById('password').value;
        if (password) {
            formData.password = password;
        }
        
        // –í–∞–ª–∏–¥–∞—Ü–∏—è
        if (!formData.full_name || !formData.email || !formData.login || !formData.role || !formData.status) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
            return;
        }
        
        if (!selectedUser && !password) {
            alert('–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω');
            return;
        }
        
        if (password && !validatePassword()) {
            alert('–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤');
            return;
        }
        
        try {
            const url = selectedUser ? 
                `/api/admin/users/${selectedUser.id}` : 
                '/api/admin/users';
                
            const method = selectedUser ? 'PUT' : 'POST';
            
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeModal();
                loadUsers();
                showNotification(selectedUser ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function deleteUser() {
        if (!selectedUser) return;
        
        document.getElementById('confirmMessage').textContent = 
            `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: "${selectedUser.full_name}" (–õ–æ–≥–∏–Ω: ${selectedUser.login})`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        if (selectedUser.role === 'admin' && adminCount <= 1) {
            document.getElementById('lastAdminWarning').style.display = 'block';
        } else {
            document.getElementById('lastAdminWarning').style.display = 'none';
        }
        
        document.getElementById('confirmModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
    async function confirmDelete() {
        if (!selectedUser) return;
        
        try {
            const response = await fetch(`/api/admin/users/${selectedUser.id}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeConfirmModal();
                selectedUser = null;
                loadUsers();
                showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    function closeConfirmModal() {
        document.getElementById('confirmModal').style.display = 'none';
    }

    // –§—É–Ω–∫—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    function toggleUserStatus() {
        if (!selectedUser) return;
        
        const newStatus = selectedUser.status === 'active' ? 'blocked' : 'active';
        const actionText = newStatus === 'blocked' ? '–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏';
        
        document.getElementById('statusConfirmTitle').textContent = 
            `‚ö†Ô∏è –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ ${actionText}`;
        document.getElementById('statusConfirmMessage').textContent = 
            `–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ ${newStatus === 'blocked' ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${selectedUser.full_name}"?`;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π –ª–∏ —ç—Ç–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
        if (selectedUser.role === 'admin' && adminCount <= 1 && newStatus === 'blocked') {
            document.getElementById('lastAdminStatusWarning').style.display = 'block';
        } else {
            document.getElementById('lastAdminStatusWarning').style.display = 'none';
        }
        
        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        const confirmBtn = document.getElementById('statusConfirmBtn');
        confirmBtn.onclick = function() { confirmStatusChange(newStatus); };
        confirmBtn.textContent = `‚úÖ ${newStatus === 'blocked' ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}`;
        confirmBtn.className = newStatus === 'blocked' ? 'btn btn-warning' : 'btn btn-success';
        
        document.getElementById('statusConfirmModal').style.display = 'block';
    }

    // –§—É–Ω–∫—Ü–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    async function confirmStatusChange(newStatus) {
        if (!selectedUser) return;
        
        try {
            const response = await fetch(`/api/admin/users/${selectedUser.id}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ status: newStatus })
            });
            
            const data = await response.json();
            
            if (data.success) {
                closeStatusConfirmModal();
                loadUsers();
                showNotification(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ ${newStatus === 'blocked' ? '–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '—Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}`, 'success');
            } else {
                alert(`–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${data.error}`);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error);
            alert('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        }
    }

    // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    function closeStatusConfirmModal() {
        document.getElementById('statusConfirmModal').style.display = 'none';
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showNotification(message, type) {
        // –ü—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        alert(message);
    }

    // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    window.refreshPageData = function() {
        loadUsers();
    };
</script>
{% endblock %}