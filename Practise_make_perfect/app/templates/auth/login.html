<!DOCTYPE html>
<html>
<head>
    <title>{% if is_admin %}–í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% else %}–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É{% endif %}</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .container {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            width: 300px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 1.5rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
        }
        input[type="text"],
        input[type="password"] {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }
        .btn {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 1rem;
        }
        .btn:hover {
            background: #45a049;
        }
        .back-btn {
            display: inline-block;
            margin-bottom: 1rem;
            color: #666;
            text-decoration: none;
        }
        .error {
            color: red;
            text-align: center;
            margin-top: 1rem;
            display: none;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–æ–∫–∞–∑–∞ –ø–∞—Ä–æ–ª—è */
        .password-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .password-wrapper input {
            padding-right: 40px;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            padding: 5px;
            border-radius: 3px;
            transition: background 0.2s;
        }
        .toggle-password:hover {
            background: #f0f0f0;
        }
        .attempts-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 0.75rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.9rem;
        }

        .attempts-warning.low {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }

        .attempts-warning.critical {
            background: #f5c6cb;
            border-color: #e74c3c;
            color: #721c24;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">‚¨ÖÔ∏è –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        <h1>{% if is_admin %}üõ†Ô∏è –í—Ö–æ–¥ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞{% else %}üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É{% endif %}</h1>

        <form id="loginForm">
           <div class="form-group">
               <label>–õ–æ–≥–∏–Ω:</label>
               <input type="text" name="username" required>
           </div>

           <div class="form-group">
               <label>–ü–∞—Ä–æ–ª—å:</label>
               <div class="password-wrapper">
                   <input type="password" name="password" required id="passwordInput">
                   <button type="button" class="toggle-password">üëÅÔ∏è</button>
               </div>
           </div>

           <!-- –ë–ª–æ–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –ø–æ–ø—ã—Ç–æ–∫ -->
           <div id="attemptsWarning" class="attempts-warning" style="display: none;">
               –û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: <span id="attemptsCount">5</span>
           </div>

           <button type="submit" class="btn">‚úÖ –í–æ–π—Ç–∏</button>
        </form>

        <div id="errorMessage" class="error"></div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–∞—Ä–æ–ª—è
        function setupPasswordToggle() {
            const toggleButton = document.querySelector('.toggle-password');
            const passwordInput = document.getElementById('passwordInput');

            if (toggleButton && passwordInput) {
                toggleButton.addEventListener('click', function() {
                    if (passwordInput.type === 'password') {
                        passwordInput.type = 'text';
                        this.textContent = 'üîí';
                    } else {
                        passwordInput.type = 'password';
                        this.textContent = 'üëÅÔ∏è';
                    }
                });
            }
        }

      document.getElementById('loginForm').addEventListener('submit', async function(e) {
          e.preventDefault();

          const formData = new FormData(this);
          const username = formData.get('username');
          const password = formData.get('password');

          // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
          document.getElementById('errorMessage').style.display = 'none';
          document.getElementById('attemptsWarning').style.display = 'none';

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –≤—Ö–æ–¥–∞
          const url = "{% if is_admin %}/api/admin_login{% else %}/api/login{% endif %}";

          try {
              const response = await fetch(url, {
                  method: 'POST',
                  headers: {
                      'Content-Type': 'application/x-www-form-urlencoded',
                  },
                  body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
              });

              const result = await response.json();

              if (result.success) {
                  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ localStorage
                  localStorage.setItem('user_login', result.user_login);
                  localStorage.setItem('user_role', result.user_role);
                  localStorage.setItem('login_type', result.login_type);
                  localStorage.setItem('is_logged_in', 'true');

                  // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ dashboard
                  window.location.href = result.redirect_url;
              } else {
                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                  document.getElementById('errorMessage').textContent = result.error;
                  document.getElementById('errorMessage').style.display = 'block';

                  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –ø–æ–ø—ã—Ç–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å
                  if (result.remaining_attempts !== undefined) {
                      const attemptsWarning = document.getElementById('attemptsWarning');
                      const attemptsCount = document.getElementById('attemptsCount');

                      attemptsCount.textContent = result.remaining_attempts;
                      attemptsWarning.style.display = 'block';

                      // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
                      if (result.remaining_attempts <= 2) {
                          attemptsWarning.className = 'attempts-warning critical';
                      } else if (result.remaining_attempts <= 3) {
                          attemptsWarning.className = 'attempts-warning low';
                      } else {
                          attemptsWarning.className = 'attempts-warning';
                      }
                  }
              }
          } catch (error) {
              document.getElementById('errorMessage').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
              document.getElementById('errorMessage').style.display = 'block';
              console.error('–û—à–∏–±–∫–∞:', error);
          }
      });

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –ø–∞—Ä–æ–ª—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        setupPasswordToggle();
    </script>
</body>
</html>