<!DOCTYPE html>
<html>
<head>
    <title>–°–≤–æ–¥–Ω—ã–π –æ—Ç—á—ë—Ç –ø–æ —Ä–∞–π–æ–Ω—É - –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç</title>
    <style>
        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–ª–∞–Ω–∫–∞ - –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ step4_report.html */
        body {
            font-family: 'Times New Roman', serif;
            margin: 0;
            padding: 20px;
            background: white;
            color: black;
            font-size: 14px;
            line-height: 1.3;
        }

        .blank-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        /* –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –∫–Ω–æ–ø–∫–∏ –∏ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ —Ä–µ–∂–∏–º–µ –ø–µ—á–∞—Ç–∏/PDF */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                padding: 0;
                margin: 0;
            }
            .blank-container {
                max-width: 100%;
                margin: 0;
            }
        }

        /* –°—Ç–∏–ª–∏ –±–ª–∞–Ω–∫–∞ –¥–ª—è —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ */
        .form-number {
            text-align: right;
            font-weight: bold;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .district-info {
            margin-bottom: 20px;
        }

        .district-line {
            margin-bottom: 8px;
        }

        .codes-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #333;
        }

        .codes-table td {
            border: 1px solid #333;
            text-align: center;
            padding: 8px;
            width: 25%;
        }

        .report-title {
            text-align: center;
            margin: 30px 0;
            font-weight: bold;
        }

        .main-title {
            font-size: 20px;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .sub-title {
            font-size: 15px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            border: 1px solid #333;
            font-size: 12px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #333;
            padding: 8px 4px;
            text-align: center;
            vertical-align: top;
        }

        .summary-table th {
            font-weight: bold;
            background-color: #f8f9fa;
        }

        .enterprise-name {
            text-align: left;
            width: 25%;
        }

        .code-col {
            width: 10%;
        }

        .plan-col {
            width: 10%;
        }

        .fact-col {
            width: 10%;
        }

        .dynamics-col {
            width: 10%;
        }

        .total-row {
            font-weight: bold;
            background-color: #e9ecef;
        }

        .signature-section {
            margin-top: 40px;
        }

        .date-line {
            margin-bottom: 40px;
        }

        .representative-section {
            display: flex;
            align-items: flex-start;
            gap: 50px;
            margin-top: 20px;
        }

        .signature-block {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 200px;
        }

        .signature-line {
            width: 200px;
            border-bottom: 1px solid #000;
            margin-bottom: 5px;
            position: relative;
            height: 20px;
        }

        .signature-label {
            font-size: 12px;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 16px;
        }

        .error {
            background: #ffe6e6;
            border: 1px solid #ff0000;
            padding: 15px;
            margin: 10px 0;
            text-align: center;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ */
        .nav-buttons {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #f5f5f5;
        }

        .btn {
            margin: 0 10px;
            padding: 8px 15px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-info {
            background: #17a2b8;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .percentage-positive { color: #28a745; }
        .percentage-negative { color: #dc3545; }
    </style>
</head>
<body>
    <!-- –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ - –±—É–¥—É—Ç —Å–∫—Ä—ã—Ç—ã –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ -->
    <div class="no-print nav-buttons">
        <a href="/reports/district/districts/{{ district_code }}/periods?user_login={{ username }}&user_role={{ user_role }}&region_code={{ region_code }}"
           class="btn btn-secondary">
            ‚¨ÖÔ∏è –ù–∞–∑–∞–¥ –∫ –ø–µ—Ä–∏–æ–¥–∞–º
        </a>
        <button onclick="exportToPDF()" class="btn btn-success">
            üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
        </button>
        <button onclick="window.print()" class="btn btn-info">
            üñ®Ô∏è –ü–µ—á–∞—Ç—å
        </button>
        <button onclick="exportEnterpriseReports()" class="btn" style="background: #6f42c1;">
            üìä –û—Ç—á–µ—Ç—ã –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
        </button>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±–ª–∞–Ω–∫–∞ -->
    <div class="blank-container" id="blank-content">
        <div class="form-number">–§–æ—Ä–º–∞ ‚Ññ –ü-5</div>

        <div class="district-info">
            <div class="district-line">
                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–∞: <strong><span id="district-name"></span></strong>
            </div>
            <div class="district-line">
                –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä —Ä–∞–π–æ–Ω–∞: <strong><span id="district-code-display"></span></strong>
            </div>
        </div>

        <table class="codes-table">
            <tr>
                <td>–ö–æ–¥ –º–∏–Ω-–≤–∞</td>
                <td>–ö–æ–¥ –æ—Ç—Ä–∞—Å–ª–∏</td>
                <td>–ö–æ–¥ –æ–±–ª–∞—Å—Ç–∏</td>
                <td>–ö–æ–¥ —Ä–∞–π–æ–Ω–∞</td>
            </tr>
            <tr>
                <td id="ministry-code">_____</td>
                <td>000</td>
                <td id="region-code-display"></td>
                <td id="district-code-value"></td>
            </tr>
        </table>

        <div class="report-title">
            <div class="main-title">–°–í–û–î–ù–´–ô –û–¢–ß–Å–¢</div>
            <div class="sub-title">–ø–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—é —É—Å–ª—É–≥ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è–º–∏ —Ä–∞–π–æ–Ω–∞ –∑–∞ <span id="report-year"></span> –≥–æ–¥</div>
        </div>

        <table class="summary-table" id="summary-table">
            <thead>
                <tr>
                    <th class="enterprise-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</th>
                    <th class="code-col">–ö–æ–¥ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è</th>
                    <th class="plan-col">–ü–ª–∞–Ω (–≤—Å–µ–≥–æ)</th>
                    <th class="plan-col">–ü–ª–∞–Ω (–≤ —Ç.—á. –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏)</th>
                    <th class="fact-col">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–≤—Å–µ–≥–æ)</th>
                    <th class="fact-col">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–≤ —Ç.—á. –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏)</th>
                    <th class="dynamics-col">–û—Ç –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞(%)(–≤—Å–µ–≥–æ)</th>
                    <th class="dynamics-col">–û—Ç –ø—Ä–æ—à–ª–æ–≥–æ –≥–æ–¥–∞(%)(–≤ —Ç.—á. –≤ —Å–µ–ª—å—Å–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏)</th>
                </tr>
            </thead>
            <tbody id="summary-body">
                <!-- –î–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
            </tbody>
            <tfoot id="summary-footer">
                <!-- –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
            </tfoot>
        </table>

        <div class="signature-section">
            <div class="date-line">
                –î–∞—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: <strong><span id="current-date"></span></strong>
            </div>

            <div class="representative-section">
                <span>–ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å —Ä–∞–π–æ–Ω–∞:</span>
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <div class="signature-label">(–ø–æ–¥–ø–∏—Å—å)</div>
                </div>
                <div class="signature-block">
                    <div class="signature-line"></div>
                    <div class="signature-label">(–§–ò–û)</div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script>
        const districtCode = {{ district_code }};
        const year = {{ year }};
        const regionCode = {{ region_code }};

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
        function formatCurrentDate() {
            const now = new Date();
            const day = now.getDate().toString().padStart(2, '0');
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const year = now.getFullYear();
            return `"${day}" ${getMonthName(now.getMonth())} ${year} –≥.`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è –º–µ—Å—è—Ü–∞
        function getMonthName(monthIndex) {
            const months = [
                '—è–Ω–≤–∞—Ä—è', '—Ñ–µ–≤—Ä–∞–ª—è', '–º–∞—Ä—Ç–∞', '–∞–ø—Ä–µ–ª—è', '–º–∞—è', '–∏—é–Ω—è',
                '–∏—é–ª—è', '–∞–≤–≥—É—Å—Ç–∞', '—Å–µ–Ω—Ç—è–±—Ä—è', '–æ–∫—Ç—è–±—Ä—è', '–Ω–æ—è–±—Ä—è', '–¥–µ–∫–∞–±—Ä—è'
            ];
            return months[monthIndex];
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–∏—Å–µ–ª
        function formatNumber(num) {
            if (num === 0 || num === null || num === undefined) return '‚Äî';
            return new Intl.NumberFormat('ru-RU').format(Math.round(num));
        }

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        function formatPercentage(num) {
            if (num === 0 || num === null || num === undefined) return '‚Äî';
            return num.toFixed(2) + '%';
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –¥–ª—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
        function getPercentageClass(value) {
            if (value === null || value === undefined) return '';
            return value >= 100 ? 'percentage-positive' : 'percentage-negative';
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞
        async function loadSummaryData() {
            try {
                const response = await fetch(`/api/district/districts/${districtCode}/periods/${year}/summary`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    renderSummaryReport(data.summary_data);
                } else {
                    showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + data.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:', error);
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞: ' + error.message);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        function showError(message) {
            const container = document.getElementById('summary-body');
            container.innerHTML = `<tr><td colspan="8" class="error">${message}</td></tr>`;
        }

        // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–ª–∞–Ω–∫–∞ –¥–∞–Ω–Ω—ã–º–∏
        function renderSummaryReport(summaryData) {
            // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            document.getElementById('district-name').textContent = summaryData.district_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
            document.getElementById('district-code-display').textContent = summaryData.district_code || '–ù–µ —É–∫–∞–∑–∞–Ω';
            document.getElementById('region-code-display').textContent = summaryData.region_code || '';
            document.getElementById('district-code-value').textContent = summaryData.district_code || '';
            document.getElementById('report-year').textContent = summaryData.year || year;

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É
            document.getElementById('current-date').textContent = formatCurrentDate();

            // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
            const summaryBody = document.getElementById('summary-body');
            summaryBody.innerHTML = '';

            summaryData.enterprises.forEach(enterprise => {
                const tr = document.createElement('tr');
                
                const dynamicsTotalClass = getPercentageClass(enterprise.dynamics_total);
                const dynamicsRuralClass = getPercentageClass(enterprise.dynamics_rural);

                tr.innerHTML = `
                    <td class="enterprise-name">${enterprise.name}</td>
                    <td>${enterprise.reg_number}</td>
                    <td>${formatNumber(enterprise.total_plan)}</td>
                    <td>${formatNumber(enterprise.rural_plan)}</td>
                    <td>${formatNumber(enterprise.total_fact)}</td>
                    <td>${formatNumber(enterprise.rural_fact)}</td>
                    <td class="${dynamicsTotalClass}">${formatPercentage(enterprise.dynamics_total)}</td>
                    <td class="${dynamicsRuralClass}">${formatPercentage(enterprise.dynamics_rural)}</td>
                `;

                summaryBody.appendChild(tr);
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç—Ä–æ–∫—É
            const summaryFooter = document.getElementById('summary-footer');
            const totals = summaryData.totals;
            
            const dynamicsTotalClass = getPercentageClass(totals.dynamics_total);
            const dynamicsRuralClass = getPercentageClass(totals.dynamics_rural);

            summaryFooter.innerHTML = `
                <tr class="total-row">
                    <td class="enterprise-name"><strong>–ò—Ç–æ–≥–æ –ø–æ —Ä–∞–π–æ–Ω—É</strong></td>
                    <td></td>
                    <td><strong>${formatNumber(totals.total_plan)}</strong></td>
                    <td><strong>${formatNumber(totals.rural_plan)}</strong></td>
                    <td><strong>${formatNumber(totals.total_fact)}</strong></td>
                    <td><strong>${formatNumber(totals.rural_fact)}</strong></td>
                    <td class="${dynamicsTotalClass}"><strong>${formatPercentage(totals.dynamics_total)}</strong></td>
                    <td class="${dynamicsRuralClass}"><strong>${formatPercentage(totals.dynamics_rural)}</strong></td>
                </tr>
            `;
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF
        function exportToPDF() {
            const element = document.getElementById('blank-content');
            const options = {
                margin: 10,
                filename: `—Å–≤–æ–¥–Ω—ã–π_–æ—Ç—á–µ—Ç_${districtCode}_${year}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: {
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: {
                    unit: 'mm',
                    format: 'a4',
                    orientation: 'portrait'
                }
            };

            html2pdf().set(options).from(element).save();
        }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—á–µ—Ç–æ–≤ –≤—Å–µ—Ö –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π
    function exportEnterpriseReports() {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–µ—Ä–≤–µ—Ä–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
         window.open(`/reports/district/districts/${districtCode}/periods/${year}/combined-reports-server?user_login={{ username }}&user_role={{ user_role }}&region_code=${regionCode}`, '_blank');
  }

       
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadSummaryData();
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        const isLoggedIn = localStorage.getItem('is_logged_in');
        if (isLoggedIn !== 'true') {
            window.location.href = '/login';
        }
    </script>
</body>
</html>